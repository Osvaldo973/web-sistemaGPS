<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sistema GPS CCN</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js"></script>

<!-- Manifest -->
<link rel="manifest" href="manifest.json" />

<style>
body,html { margin:0; padding:0; height:100%; background:#0f0f0f; color:#fff; font-family:Arial, sans-serif; }
#map { height:100%; width:100%; }
.panel { position:absolute; top:0; left:0; background:#151515; width:320px; height:100%; overflow:auto; padding:15px; box-shadow:2px 0 10px rgba(0,0,0,0.6); z-index:1000; transition:transform .3s ease; }
.panel.hidden { transform:translateX(-100%); }
.panel h2 { margin-top:0; color:#00bfa5; }
.btn { display:block; background:#00bfa5; color:#fff; border:none; padding:8px 10px; margin:6px 0; width:100%; cursor:pointer; border-radius:6px; font-weight:bold; }
.btn:hover { background:#00d8b2; }
#togglePanel { position:absolute; top:10px; left:10px; z-index:1100; background:#00bfa5; border:none; color:#fff; padding:8px 10px; border-radius:5px; cursor:pointer; }
#toast { position:fixed; bottom:25px; left:50%; transform:translateX(-50%); background:#323232; color:#fff; padding:10px 20px; border-radius:6px; opacity:0; transition:opacity .4s; z-index:2000; }
#toast.show { opacity:1; }
.historial-container { margin-top:15px; }
.mini-map { width:100%; height:120px; margin:6px 0; border:1px solid #333; border-radius:8px; }
.mini-map-info { font-size:12px; color:#ccc; margin-bottom:10px; }
@media(max-width:768px){ .panel{width:85%;} }
</style>
</head>

<body>
<button id="togglePanel">☰</button>

<!-- PANEL -->
<div class="panel hidden" id="sidePanel">
  <h2>Panel de Control</h2>
  <button class="btn" id="btnAgregarEst">Agregar Establecimiento</button>
  <button class="btn" id="btnVerRutas">Ver Rutas</button>
  <button class="btn" id="btnHistorial">Historial</button>
  <button class="btn" id="btnEliminarRecorrido">Eliminar Recorrido del Mapa</button>
  <button class="btn" id="btnStartTracking">Activar Seguimiento GPS</button>
  <div class="historial-container" id="historialContainer"></div>
</div>

<!-- MAPA -->
<div id="map"></div>
<div id="toast"></div>

<script>
/* -----------------------------
   CONFIGURACIÓN FIREBASE
----------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBNDvalpKia91Sx8LpOf9KYRwrLmYKjjx8",
  authDomain: "system-gps-ccn.firebaseapp.com",
  databaseURL: "https://system-gps-ccn-default-rtdb.firebaseio.com",
  projectId: "system-gps-ccn",
  storageBucket: "system-gps-ccn.appspot.com",
  messagingSenderId: "490798984373",
  appId: "1:490798984373:web:fc9e47dc8ddac1a79fdc16"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.getDatabase(app);

/* -----------------------------
   MAPA
----------------------------- */
const map = L.map('map').setView([18.7357, -70.1627], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let estMarkers = {};
let rutasActivas = [];

/* -----------------------------
   TOAST
----------------------------- */
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 3000);
}

/* -----------------------------
   PANEL RESPONSIVO
----------------------------- */
const sidePanel = document.getElementById('sidePanel');
document.getElementById('togglePanel').addEventListener('click', ()=> {
  sidePanel.classList.toggle('hidden');
});

/* -----------------------------
   AGREGAR ESTABLECIMIENTO
----------------------------- */
document.getElementById('btnAgregarEst').addEventListener('click', ()=>{
  showToast('Haz clic en el mapa para agregar un establecimiento');
  map.once('click', e=>{
    const name = prompt('Nombre del establecimiento:');
    if(!name) return;
    const marker = L.marker(e.latlng, {title:name, draggable:true}).addTo(map);
    marker.bindPopup(`<b>${name}</b><br><button onclick="editarEst('${name}')">Editar</button> <button onclick="eliminarEst('${name}')">Eliminar</button>`);
    estMarkers[name] = marker;
    firebase.set(firebase.ref(db,'establecimientos/'+name), { lat:e.latlng.lat, lon:e.latlng.lng, name });
  });
});

/* -----------------------------
   EDITAR / ELIMINAR ESTABLECIMIENTO
----------------------------- */
window.editarEst = (name)=>{
  const nuevo = prompt('Nuevo nombre para '+name+':');
  if(!nuevo) return;
  const dataRef = firebase.ref(db,'establecimientos/'+name);
  firebase.get(dataRef).then(snap=>{
    if(snap.exists()){
      const val = snap.val();
      firebase.remove(dataRef);
      firebase.set(firebase.ref(db,'establecimientos/'+nuevo), { ...val, name:nuevo });
      showToast('Establecimiento renombrado');
      location.reload();
    }
  });
};
window.eliminarEst = (name)=>{
  if(confirm('¿Eliminar establecimiento '+name+'?')){
    firebase.remove(firebase.ref(db,'establecimientos/'+name));
    if(estMarkers[name]) map.removeLayer(estMarkers[name]);
    showToast('Establecimiento eliminado');
  }
};

/* -----------------------------
   VER RUTAS ENTRE PUNTOS
----------------------------- */
let puntosRuta = [];
document.getElementById('btnVerRutas').addEventListener('click', ()=>{
  showToast('Selecciona 2 puntos en el mapa para ver la ruta');
  map.on('click', marcarRuta);
});
function marcarRuta(e){
  puntosRuta.push(e.latlng);
  L.marker(e.latlng).addTo(map);
  if(puntosRuta.length===2){
    const route = L.Routing.control({
      waypoints:[L.latLng(puntosRuta[0]),L.latLng(puntosRuta[1])],
      routeWhileDragging:false
    }).addTo(map);
    rutasActivas.push(route);
    map.off('click', marcarRuta);
    showToast('Ruta generada y guardada en Firebase');
    firebase.push(firebase.ref(db,'rutas'), { from:puntosRuta[0], to:puntosRuta[1], fecha:new Date().toISOString() });
    puntosRuta = [];
  }
}

/* -----------------------------
   ELIMINAR RUTAS VISUALES
----------------------------- */
document.getElementById('btnEliminarRecorrido').addEventListener('click', ()=>{
  rutasActivas.forEach(r => map.removeControl(r));
  rutasActivas = [];
  showToast('Recorridos removidos del mapa (guardados en base de datos)');
});

/* -----------------------------
   HISTORIAL DIARIO CON MINI MAPAS
----------------------------- */
document.getElementById('btnHistorial').addEventListener('click', cargarHistorial);
function cargarHistorial(){
  const cont = document.getElementById('historialContainer');
  cont.innerHTML = '<h3>Historial de Rutas</h3>';
  firebase.get(firebase.ref(db,'rutas')).then(snapshot=>{
    if(!snapshot.exists()){ cont.innerHTML+='No hay rutas registradas'; return; }
    snapshot.forEach(snap=>{
      const val = snap.val();
      const el = document.createElement('div');
      el.className='mini-map';
      const info = document.createElement('div');
      info.className='mini-map-info';
      info.innerHTML = `Fecha: ${val.fecha}`;
      cont.appendChild(info);
      cont.appendChild(el);
      const m = L.map(el,{attributionControl:false,zoomControl:false});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
      const pts = [ [val.from.lat,val.from.lng],[val.to.lat,val.to.lng] ];
      L.polyline(pts,{color:'#00bfa5',weight:3}).addTo(m);
      m.fitBounds(L.latLngBounds(pts),{padding:[10,10]});
    });
  });
}

/* -----------------------------
   SEGUIMIENTO GPS EN TIEMPO REAL + BACKGROUND SYNC
----------------------------- */
let watchId = null;
document.getElementById('btnStartTracking').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocalización no soportada'); return; }
  showToast('Activando seguimiento GPS...');
  watchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    const now = new Date().toISOString();
    firebase.push(firebase.ref(db,'tracking'), {lat:latitude, lon:longitude, fecha:now});
  }, err=> console.error(err), {enableHighAccuracy:true, maximumAge:0, timeout:10000});
  if('serviceWorker' in navigator && 'SyncManager' in window){
    navigator.serviceWorker.ready.then(reg=> reg.sync.register('track-location'));
  }
});

/* -----------------------------
   REGISTRO SERVICE WORKER
----------------------------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=> console.log('Service Worker activo'));
}
</script>
</body>
</html>
